# Store에서 비동기 통신 분리하기 (feat. React Query)

- https://techblog.woowahan.com/6339/

## React Query를 도입하기로 했던 배경

- 최근에 개발하면서 Store가 너무 비대해졌다고 느끼신 순간이 없으신가요?
- 제가 위에서 질문의 출발점은 FE 개발에서 전역 상태 관리를 위해서 Store를 사용하고 있는 것은 맞지만 상당 부분이 비동기 통신을 위해 쓰이고 있는 것 같다는 생각이었습니다.

## Redux로 구현하는 Store 예시를 통한 코드 분석

isFetch, isError 모두 AJAX 상태와 응답값을 바라보는 상태들이 생기게 됩니다. 이러한 것들을 모두 전역 상태에 넣고 굉장히 비효율적이고 불필요한 부분이 존재합니다.
Store는 상태를 관리하는 코드라고 떠오를까요, 아니면 API 통신을 담당하는 코드라고 떠오를까요? 이 질문에 더해 그러면 우리가 만드는 프로덕트가 Redux나 Mobx를 이용해 만든 코드들이 저런 API 통신이 많은지, 아니면 순수 Client의 상태와 관련된 코드가 한번 생각해 봅시다. 적어도 저는 Store에 API 통신과 그에 관련된 정책이 훨씬 많았던 것 같습니다.

- 오히려 관성적으로 해당 라이브러리들을 사용하면서 비동기 통신을 위해 *상태 관리 라이브러리를 쓰고 부가적으로 전역 상태 관리*를 쓰고 있지 않을까요?
- 이 때문에 불필요한 상태나 로직들이 많아지면서 Store가 너무 비대해지고 여러 비효율이 발생하고 있진 않을까요?
- 더 나은 방법은 없었을까요?

여기까지 왔을 때 제가 도달한 생각은 ‘어쩌면 기존에 우리가 FE에서 사용하고 있는 전역 상태 관리 방법들은 API 통신과 서버 상태 관리에 어쩌면 적정기술이 아닐 수도 있겠다.‘ 입니다.
그러기 위해서 먼저, 제가 해결하고자 하는 문제가 무엇일까 생각을 해보고 아래와 같이 정리해 보았습니다.

1. Store에서 비동기 통신을 걷어내고 온전한 Client Side 전역 상태 관리로 탈바꿈
2. 각종 API 통신과 sync를 맞춰야 하므로 Store 밖에서 서버와 관련된 상태 관리방안 마련
3. 2번이 가능하면서도 서버와 관련된 상태는 마치 전역 상태처럼 사용할 수 있어야 함

## React Query

- React Query는 Server State를 관리하는 라이브러리로 React 프로젝트에서 Server와 Client 사이 비동기 로직들을 손쉽게 다루게 해주는 도구

React Query는 Server State를 다룬다고 위에서 설명했는데 여기서 Server State란 공식 홈페이지에서 아래와 같이 설명하고 있습니다.

- Client에서 제어하거나 소유되지 않은 원격의 공간에서 관리되고 유지됨
- Fetching이나 Updating에 비동기 API가 필요함
- 다른 사람들과 공유되는 것으로 사용자가 모르는 사이에 변경될 수 있음
- 신경 쓰지 않는다면 잠재적으로 "out of date"가 될 가능성을 지님

## React Query를 도입한 후 Store와 Component는

- 원래 방식이라면 구현하기 위해서 아주 많은 Store 코드가 필요했을 것이지만 2~3개의 Store만 남았습니다.
- 위에 Store 코드가 없는 이유도 주문정보를 불러오는 데 관여하는 Store가 없어서입니다.
- Component는 조금 더 비대해지긴 했으나 onSuccess와 onError 같은 것들을 service layer로 빼고 나니 기존에 Store에서 제공해 주는 인터페이스를 호출하는 코드와 거의 비슷한 규모가 되어 마치 React Hooks를 활용한 Container Component를 구현한 느낌이었습니다.

- 하지만 단점도 있다고 느꼈는데 비동기 로직들이 프로젝트 설계에 신경 쓰지 않았다면 정말 추후 관리나 확장이 어려워질 정도로 Component에 유착된다든지 아니면 어디서 쓰이고 있는지 파악이 더 힘들어질 수 있을 것 같다는 생각도 들었습니다.

## 마치며

- 트렌드가 계속 바뀌는 Frontend 개발에 있어서 *기술의 적합성과 최신성*은 끊임없이 검토하고 필요하다고 판단되면 조심히 때론 과감히 시도해야 한다고 생각합니다.
- 하지만 여기에 명확한 Why 즉, 이유, 의도가 필요하다고 생각하고, 제가 적은 글이 우리가 왜 React Query를 도입하기로 했는지에 대한 Why입니다. Why가 명확한 엔지니어링을 통해 만든 설계, 기술, 개발이 좋은 사용자 경험으로 이어질 것이라 저는 믿습니다.

## My Opinion

- Store를 전역 상태에서 관리해야하는가에 대한 의문이 있었고 대부분의 비즈니스로직들이 화면단위로 하나의 비동기 통신하며 하나의 책임을 갖고 상태관리한다는 것을 발견하여 Scope(Global, Screen, Component)범위로 상태관리했었고 이후 더나아가 API 통신, 서버 상태 관리의 적정기준으론 React-Query가 더 효율적으로 관리할 수 있다 생각합니다.
- 그래서 Mobx일 경우, Store를 Scope단위로 나누어 전역 상태관리 부담을 줄인다면 어느정도 React-Query와 유사한 효과를 얻을 수 있을지 않을까 생각합니다.
  - 그렇더라도 현재 기준으론 suspense, optimistic update.. 부가적인 API 통신에 필요한 기능들이 다양하게 제공하기에 굳이 React-Query를 쓰지 않고 Mobx로만 구성할 필요도 없기에 현재 프로젝트 상황에 따라 결정해야할듯 싶긴합니다.
